<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCP - Painel de Controle</title>
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- v1.5.4: Firebase SDK Removido -->
    <style>
        /* Tema Dark (mantido) */
        :root {
            --bg-primary: #0D1117;
            --bg-secondary: #161B22;
            --border-color: #30363D;
            --text-primary: #C9D1D9;
            --text-secondary: #8B949E;
            --accent-primary: #58A6FF;
            --accent-secondary: #1F6FEB;
            --highlight-red: #DA3633;
            --highlight-green: #238636;
            --highlight-bg-red: rgba(218, 54, 51, 0.15);
            --highlight-bg-green: rgba(35, 134, 54, 0.15);
            --completed-bg: #21262d;
            --completed-text: #8B949E;
            --icon-completed-color: #238636;
            --icon-partial-color: #D97706;
        }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .table-container { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; border-spacing: 0; margin-top: 1rem; border: 1px solid var(--border-color); }
        th, td { border: 1px solid var(--border-color); padding: 0.75rem 1rem; text-align: left; white-space: nowrap; }
        th { background-color: #21262D; color: var(--text-primary); font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even):not(.completed-row) { background-color: rgba(22, 27, 34, 0.5); }
        tbody tr:hover:not(.completed-row) { background-color: #21262D; }
        .completed-row td { background-color: var(--completed-bg) !important; color: var(--completed-text); text-decoration: line-through; }
        .completed-row td input[type="checkbox"] { opacity: 0.7; }
        .po-status-icon { margin-left: 0.5rem; font-size: 0.9em; font-weight: bold; display: inline-block; }
        .po-status-completed { color: var(--icon-completed-color); }
        .po-status-partial { color: var(--icon-partial-color); }
        .metric-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 1.5rem; text-align: center; }
        .metric-label { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem; display: block; }
        .metric-value { font-size: 1.875rem; font-weight: 600; color: var(--text-primary); }
        .btn { background-color: var(--accent-primary); color: var(--bg-primary); padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; border: none; }
        .btn:hover { background-color: var(--accent-secondary); }
        .btn-filter { background-color: var(--bg-secondary); color: var(--accent-primary); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid var(--border-color); margin-right: 0.5rem; }
        .btn-filter:hover { background-color: var(--accent-secondary); color: var(--bg-primary); border-color: var(--accent-secondary); }
        
        /* Estilo para ambas as listas suspensas */
        .po-select-list {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 100%;
            border-radius: 6px;
            padding: 0.5rem;
            height: 10rem;
            overflow-y: auto;
             -webkit-tap-highlight-color: transparent;
        }
        .po-select-list option {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            cursor: pointer;
        }
        .po-select-list option:checked,
        .po-select-list option:hover:checked {
             background-color: var(--accent-secondary);
             color: var(--bg-primary);
             font-weight: bold;
        }
        .po-select-list option:hover:not(:checked) {
            background-color: #21262D;
        }

        .status-box { padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; transition: opacity 0.5s ease-out; }
        .status-loading { background-color: rgba(251, 191, 36, 0.1); border: 1px solid #D97706; color: #FBBF24; }
        .status-success { background-color: rgba(16, 185, 129, 0.1); border: 1px solid #059669; color: #34D399; }
        .status-error { background-color: rgba(239, 68, 68, 0.1); border: 1px solid #DC2626; color: #F87171; }
        .highlight-red { background-color: var(--highlight-bg-red); color: var(--highlight-red); font-weight: bold; }
        .highlight-green { background-color: var(--highlight-bg-green); color: var(--highlight-green); font-weight: bold; }
        @keyframes pulse-red { 0%, 100% { background-color: var(--highlight-bg-red); } 50% { background-color: rgba(218, 54, 51, 0.3); } }
        .pulse-red { animation: pulse-red 2s infinite ease-in-out; }
        #completed-po-scroller { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5rem 0; margin-bottom: 1.5rem; overflow: hidden; height: 2.5rem; display: none; white-space: nowrap; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        #scroller-content { display: inline-block; padding-left: 100%; animation: scroll-left 30s linear infinite; color: var(--icon-completed-color); font-weight: bold; font-size: 0.875rem; line-height: 1.5rem; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        #completed-po-scroller:hover #scroller-content { animation-play-state: paused; }
    </style>
</head>
<body class="grid grid-cols-12 gap-4 p-4 min-h-screen">

    <!-- Sidebar (Mais Fina) -->
    <aside class="col-span-12 md:col-span-2 card flex flex-col">
        <img id="logo" src="logo.jpg" alt="Logo" class="mb-6 max-h-16 object-contain self-center" onerror="this.style.display='none'; document.getElementById('logo-error').style.display='block';">
         <p id="logo-error" class="text-xs text-red-400 text-center mb-4" style="display: none;">Logo 'logo.jpg' não encontrada (Coloque na mesma pasta do HTML).</p>

        <button id="reload-button" class="btn w-full mb-6">Recarregar Dados</button>

        <!-- v1.5.0: Primeiro Filtro (Principal) -->
        <h2 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Filtro de POs (Tabelas)</h2>
        <div class="mb-2">
            <button id="select-all-po" class="btn-filter">Selecionar Todas</button>
            <button id="clear-all-po" class="btn-filter">Limpar Seleção</button>
        </div>
        <div id="po-filter-container" class="mb-4 flex-grow overflow-y-auto" style="height: 10rem;">
            <p id="po-loading" class="text-sm text-gray-400">Carregando POs...</p>
             <select id="po-select" multiple class="po-select-list"></select>
        </div>
        <p id="po-empty" class="text-sm text-green-400 hidden">✅ Nenhum pedido pendente!</p>
        <!-- FIM v1.5.0 -->

        <!-- v1.5.0: Segundo Filtro (Reserva de Estoque) -->
        <h2 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Filtro Reserva (Simulação)</h2>
        <p class="text-xs text-gray-400 mb-2">Selecione POs aqui para *subtrair* do estoque no painel "Planejamento da Produção".</p>
        <div class="mb-2">
            <button id="select-all-po-reserva" class="btn-filter">Selecionar Todas</button>
            <button id="clear-all-po-reserva" class="btn-filter">Limpar Seleção</button>
        </div>
        <div id="po-filter-container-reserva" class="mb-4 flex-grow overflow-y-auto" style="height: 10rem;">
            <p id="po-loading-reserva" class="text-sm text-gray-400">Carregando POs...</p>
             <select id="po-select-reserva" multiple class="po-select-list"></select>
        </div>
        <p id="po-empty-reserva" class="text-sm text-green-400 hidden">✅ Nenhum pedido pendente!</p>
        <!-- FIM v1.5.0 -->


        <div class="mt-auto border-t border-gray-700 pt-4">
            <h3 class="text-md font-semibold mb-2">Base de Dados</h3>
            <div id="data-status" class="text-xs text-gray-400">Verificando...</div>
             <div id="data-last-updated" class="text-xs text-gray-500 mt-1"></div>
             <p class="text-xs text-gray-500 mt-2">Desenvolvido por: Tales_Solidade</p>
             <!-- v1.5.4: Atualização da versão -->
             <p class="text-xs text-gray-500 mt-1">Versão: 1.5.4</p>
             <!-- FIM v1.5.4 -->
        </div>
    </aside>

    <!-- Main Content (Mais Largo) -->
    <main class="col-span-12 md:col-span-10">
        <div class="card mb-4">
             <h1 class="text-2xl font-bold mb-1">PCP - PLANEJAMENTO E CONTROLE DE PRODUÇÃO</h1>
             <p id="painel-info" class="text-sm text-gray-400"></p>
        </div>

        <div id="completed-po-scroller">
            <div id="scroller-content"></div>
        </div>

        <div id="global-status" class="status-box status-loading">Status: Carregando dados...</div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Resumo de Pedidos em Carteira Total</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="metric-card">
                    <span class="metric-label">Total de POs em Carteira</span>
                    <span id="metric-pos" class="metric-value">0 POs</span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">Total de Pacotes em Carteira</span>
                    <span id="metric-pacotes" class="metric-value">0 pcts</span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">Total de M³ em Carteira</span>
                    <span id="metric-m3" class="metric-value">0.000 m³</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-2">Planejamento da Produção</h2>
            <p class="text-sm text-gray-400 mb-4">Este painel é recalculado com base nas POs selecionadas no filtro da barra lateral.</p>
            <div class="table-container">
                <table id="dashboard-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Perfil</th>
                            <th>M³ Carteira</th>
                            <th>M³ Estoque</th>
                            <th>Pacotes Carteira</th>
                            <th>Pacotes Estoque</th>
                            <th>M³ A produzir</th>
                            <th>Pacotes A produzir</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8" class="text-center text-gray-500 py-4">Calculando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Tabela de Itens em Carteira (Filtrada por PO)</h2>
             <div class="table-container">
                <table id="detail-table">
                    <thead>
                        <tr>
                            <th>Concluído?</th>
                            <th>PO</th>
                            <th>Cliente</th>
                            <th>Perfil</th>
                            <th>Produto</th>
                            <th>Em Carteira Pacotes</th>
                            <th>Em Carteira M³</th>
                        </tr>
                    </thead>
                    <tbody>
                         <tr><td colspan="7" class="text-center text-gray-500 py-4">Calculando...</td></tr>
                    </tbody>
                </table>
            </div>
             <p id="detail-empty" class="text-sm text-green-400 mt-4 hidden">✅ Nenhum item em carteira para as POs selecionadas!</p>
        </div>

    </main>

    <script id="script-dados" src=""></script>

    <script> // v1.5.4: NÃO é mais type="module"
        // --- Constantes e Variáveis Globais ---
        const CAMINHO_JS = "dados_atuais.js";
        let ALL_PENDING_ITEMS = [];
        let ALL_STOCK_ITEMS = [];
        let uniquePOs = [];
        let selectedPOs = new Set();
        let reservedPOs = new Set(); // v1.5.0
        let lastDataLoadTime = null;
        let globalStatusTimeout = null;
        let completionStatus = {};
        const STORAGE_KEY = 'pcpCompletionStatus'; // v1.5.4: Usando localStorage

        // --- Funções de Formatação ---
        function formatNumber(num, decimals = 0) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            return num.toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function formatM3(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0.000 m³';
            return num.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + ' m³';
        }
         function formatPct(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0 pcts';
            return formatNumber(Math.round(num), 0) + ' pcts';
        }
        function formatPO(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0 POs';
            return formatNumber(num, 0) + ' POs';
        }

        // --- Funções de Cálculo ---
        function getPecasPorPacote(perfil) { return perfil === 'LS4S' ? 294 : 420; }
        
        function calcularResumoTotal(pendingItems) {
            const itemsEmCarteira = pendingItems.filter(item => (item.Pendente_Pecas || 0) > 0 || (item.Pendente_M3 || 0) > 0.001);
            const totalPOs = new Set(itemsEmCarteira.map(item => item.PO)).size;
            let totalPacotes = 0; let totalM3 = 0;
            itemsEmCarteira.forEach(item => {
                const pendentePecas = item.Pendente_Pecas || 0;
                totalM3 += item.Pendente_M3 || 0;
                if (pendentePecas > 0) {
                    totalPacotes += Math.round(pendentePecas / getPecasPorPacote(item.Perfil));
                }
            });
            return { totalPOs, totalPacotes, totalM3 };
        }
        
        function calcularDashboard(filteredItems, adjustedStockItems) {
            const carteiraAgrupada = filteredItems.reduce((acc, item) => {
                const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`;
                if (!acc[key]) acc[key] = { Produto: item.Produto, Perfil: item.Perfil, Solicitado_Pecas: 0, Solicitado_M3: 0 };
                acc[key].Solicitado_Pecas += item.Pendente_Pecas || 0; acc[key].Solicitado_M3 += item.Pendente_M3 || 0; return acc;
            }, {});
            const estoqueMap = adjustedStockItems.reduce((acc, item) => {
                 const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`;
                 acc[key] = { M3_Estoque_Liquido: item.M3_Estoque_Liquido || 0, Pecas_Estoque_Liquido: item.Pecas_Estoque_Liquido || 0 }; return acc;
            }, {});
            const dashboardData = [];
            Object.values(carteiraAgrupada).forEach(carteiraItem => {
                const key = `${carteiraItem.Produto || 'N/A'}|${carteiraItem.Perfil || 'N/A'}`;
                const estoqueItem = estoqueMap[key] || { M3_Estoque_Liquido: 0, Pecas_Estoque_Liquido: 0 };
                const pecasPorPacote = getPecasPorPacote(carteiraItem.Perfil);
                const m3Carteira = carteiraItem.Solicitado_M3; const pecasCarteira = carteiraItem.Solicitado_Pecas;
                const m3Estoque = estoqueItem.M3_Estoque_Liquido; const pecasEstoque = estoqueItem.Pecas_Estoque_Liquido;
                const m3AProduzir = Math.max(0, m3Carteira - m3Estoque); const pecasAProduzir = Math.max(0, pecasCarteira - pecasEstoque);
                
                const pacotesCarteira = Math.round(pecasCarteira / pecasPorPacote);
                const pacotesEstoque = Math.floor(pecasEstoque / pecasPorPacote);
                const pacotesAProduzir = Math.round(pecasAProduzir / pecasPorPacote);

                dashboardData.push({
                    Produto: carteiraItem.Produto, Perfil: carteiraItem.Perfil,
                    M3_Carteira_Volume: m3Carteira, M3_Estoque_Liquido: m3Estoque,
                    Pacotes_Carteira: pacotesCarteira, Pacotes_Estoque: pacotesEstoque,
                    M3_A_Produzir: m3AProduzir, Pacotes_A_Produzir: pacotesAProduzir,
                });
            });
             adjustedStockItems.forEach(item => {
                const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`;
                 if (!carteiraAgrupada[key] && (item.Pecas_Estoque_Liquido > 0 || item.M3_Estoque_Liquido > 0.001)) {
                    dashboardData.push({
                        Produto: item.Produto, Perfil: item.Perfil, M3_Carteira_Volume: 0, M3_Estoque_Liquido: item.M3_Estoque_Liquido,
                        Pacotes_Carteira: 0, Pacotes_Estoque: Math.floor(item.Pecas_Estoque_Liquido / getPecasPorPacote(item.Perfil)),
                        M3_A_Produzir: 0, Pacotes_A_Produzir: 0,
                    });
                 }
            });
             dashboardData.sort((a, b) => { const pc = (a.Produto || '').localeCompare(b.Produto || ''); return pc !== 0 ? pc : (a.Perfil || '').localeCompare(b.Perfil || ''); });
            return dashboardData.filter(item => item.M3_Carteira_Volume > 0.001 || item.M3_Estoque_Liquido > 0.001);
        }

        // --- Funções de Renderização ---
        function renderPOFilters() {
            const poSelect = document.getElementById('po-select'); const poEmpty = document.getElementById('po-empty'); const poLoading = document.getElementById('po-loading');
            const poSelectReserva = document.getElementById('po-select-reserva'); const poEmptyReserva = document.getElementById('po-empty-reserva'); const poLoadingReserva = document.getElementById('po-loading-reserva');
            poSelect.innerHTML = ''; poSelectReserva.innerHTML = '';
            if (uniquePOs.length === 0) {
                 poLoading.style.display = 'none'; poEmpty.style.display = 'block'; poSelect.style.display = 'none';
                 poLoadingReserva.style.display = 'none'; poEmptyReserva.style.display = 'block'; poSelectReserva.style.display = 'none';
                 return;
            }
            poLoading.style.display = 'none'; poEmpty.style.display = 'none'; poSelect.style.display = 'block';
            poLoadingReserva.style.display = 'none'; poEmptyReserva.style.display = 'none'; poSelectReserva.style.display = 'block';
            uniquePOs.forEach(po => {
                const optionMain = document.createElement('option'); optionMain.value = po; optionMain.textContent = po; optionMain.selected = selectedPOs.has(po);
                poSelect.appendChild(optionMain);
                const optionReserva = document.createElement('option'); optionReserva.value = po; optionReserva.textContent = po; optionReserva.selected = reservedPOs.has(po);
                poSelectReserva.appendChild(optionReserva);
            });
        }
        function renderSummary(summary) { document.getElementById('metric-pos').textContent = formatPO(summary.totalPOs); document.getElementById('metric-pacotes').textContent = formatPct(summary.totalPacotes); document.getElementById('metric-m3').textContent = formatM3(summary.totalM3); }
        function renderDashboard(dashboardData) {
            const tbody = document.getElementById('dashboard-table').querySelector('tbody'); tbody.innerHTML = '';
            if (dashboardData.length === 0) { tbody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-4">Nenhum dado para exibir.</td></tr>`; return; }
            dashboardData.forEach(item => {
                 const am3 = item.M3_A_Produzir || 0; const apct = item.Pacotes_A_Produzir || 0;
                 const cm3 = am3 > 0.001 ? 'highlight-red' : ''; const cpct = apct > 0 ? 'highlight-red' : '';
                 const pm3 = cm3 ? ' pulse-red' : ''; const ppct = cpct ? ' pulse-red' : '';
                tbody.innerHTML += `
                    <tr><td>${item.Produto || 'N/A'}</td><td>${item.Perfil || 'N/A'}</td><td>${formatM3(item.M3_Carteira_Volume)}</td><td>${formatM3(item.M3_Estoque_Liquido)}</td>
                    <td>${formatPct(item.Pacotes_Carteira)}</td> <td>${formatPct(item.Pacotes_Estoque)}</td>
                    <td class="${cm3}${pm3}">${formatM3(am3)}</td><td class="${cpct}${ppct}">${formatPct(apct)}</td></tr>`;
            });
        }
        function renderDetailTable(filteredItems) {
            const tbody = document.getElementById('detail-table').querySelector('tbody'); const emptyMsg = document.getElementById('detail-empty'); tbody.innerHTML = '';
             if (filteredItems.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">${(selectedPOs.size === 0 && uniquePOs.length > 0) ? 'Nenhuma PO selecionada.' : 'Nenhum item encontrado.'}</td></tr>`; emptyMsg.style.display = 'block'; renderCompletedPOScroller([]); return; }
             emptyMsg.style.display = 'none';
             const poStatusMap = {}; const poCompletionState = {}; const completedPOs = [];
             filteredItems.forEach(item => { const po = item.PO || 'na'; const itemId = generateItemId(item); if (!poStatusMap[po]) poStatusMap[po] = { total: 0, completed: 0 }; poStatusMap[po].total++; if (completionStatus[itemId] === true) poStatusMap[po].completed++; });
             for (const po in poStatusMap) { if (poStatusMap[po].completed === 0) poCompletionState[po] = 'pending'; else if (poStatusMap[po].completed === poStatusMap[po].total) {poCompletionState[po] = 'full'; completedPOs.push(po);} else poCompletionState[po] = 'partial'; }
             completedPOs.sort();
            filteredItems.sort((a, b) => { const pc = (a.PO || '').localeCompare(b.PO || ''); return pc !== 0 ? pc : (a.Produto || '').localeCompare(b.Produto || ''); });
            filteredItems.forEach(item => {
                const itemId = generateItemId(item); const isItemCompleted = completionStatus[itemId] === true; const poState = poCompletionState[item.PO || 'na'];
                const emCarteiraPct = Math.round((item.Pendente_Pecas || 0) / getPecasPorPacote(item.Perfil)); const emCarteiraM3 = item.Pendente_M3 || 0;
                let rowClass = ''; let poIndicatorIcon = '';
                if (poState === 'full') { rowClass = 'completed-row'; poIndicatorIcon = '<span class="po-status-icon po-status-completed">✓</span>'; }
                else if (poState === 'partial') { poIndicatorIcon = '<span class="po-status-icon po-status-partial">⚠️</span>'; if (isItemCompleted) rowClass = 'completed-row';}
                else { if (isItemCompleted) rowClass = 'completed-row'; }
                tbody.innerHTML += `
                    <tr class="${rowClass}" data-item-id="${itemId}"> <td class="text-center"><input type="checkbox" class="form-checkbox h-4 w-4" ${isItemCompleted ? 'checked' : ''} onchange="toggleItemCompletion(this)"></td> <td>${item.PO || 'N/A'}${poIndicatorIcon}</td> <td>${item.Cliente || 'N/A'}</td> <td>${item.Perfil || 'N/A'}</td> <td>${item.Produto || 'N/A'}</td> <td>${formatPct(emCarteiraPct)}</td> <td>${formatM3(emCarteiraM3)}</td> </tr>`;
            });
             renderCompletedPOScroller(completedPOs);
        }
        function renderCompletedPOScroller(completedPOs) {
             const scrollerC = document.getElementById('completed-po-scroller'); const scrollerCt = document.getElementById('scroller-content');
             if (completedPOs.length > 0) { scrollerCt.textContent = "POs Concluídas: " + completedPOs.join(' ✓ | ') + ' ✓'; scrollerC.style.display = 'block'; }
             else { scrollerC.style.display = 'none'; scrollerCt.textContent = ''; }
         }

        // --- Funções de Interação ---
        function selectAllPOs() {
             const poSelect = document.getElementById('po-select'); selectedPOs.clear();
             for (let i = 0; i < poSelect.options.length; i++) { poSelect.options[i].selected = true; selectedPOs.add(poSelect.options[i].value); }
             poSelect.dispatchEvent(new Event('change'));
             updateDashboardAndDetail();
        }
        function clearAllPOs() {
            const poSelect = document.getElementById('po-select');
            for (let i = 0; i < poSelect.options.length; i++) poSelect.options[i].selected = false;
             selectedPOs.clear(); poSelect.dispatchEvent(new Event('change'));
             updateDashboardAndDetail();
        }
        function handleMainPOSelectionChange() {
            const poSelect = document.getElementById('po-select'); selectedPOs.clear();
            for (let i = 0; i < poSelect.selectedOptions.length; i++) selectedPOs.add(poSelect.selectedOptions[i].value);
            updateDashboardAndDetail();
        }
        function selectAllPOsReserva() {
             const poSelect = document.getElementById('po-select-reserva'); reservedPOs.clear();
             for (let i = 0; i < poSelect.options.length; i++) { poSelect.options[i].selected = true; reservedPOs.add(poSelect.options[i].value); }
             poSelect.dispatchEvent(new Event('change'));
             updateDashboardAndDetail();
        }
        function clearAllPOsReserva() {
            const poSelect = document.getElementById('po-select-reserva');
            for (let i = 0; i < poSelect.options.length; i++) poSelect.options[i].selected = false;
             reservedPOs.clear(); poSelect.dispatchEvent(new Event('change'));
             updateDashboardAndDetail();
        }
        function handleReservationSelectionChange() {
            const poSelect = document.getElementById('po-select-reserva'); reservedPOs.clear();
            for (let i = 0; i < poSelect.selectedOptions.length; i++) reservedPOs.add(poSelect.selectedOptions[i].value);
            updateDashboardAndDetail();
        }

        function updateDashboardAndDetail() {
             console.log("[DEBUG] Atualizando. POs Filtro Principal:", selectedPOs);
             console.log("[DEBUG] Atualizando. POs Filtro Reserva:", reservedPOs);
             if (!ALL_PENDING_ITEMS || !ALL_STOCK_ITEMS) { console.warn("[DEBUG] Dados ainda não carregados."); renderDashboard([]); renderDetailTable([]); return; }
             const filteredItemsEmCarteira = ALL_PENDING_ITEMS.filter(item => { const poValue = item && item.PO ? String(item.PO) : null; return poValue && selectedPOs.has(poValue); });
             console.log("[DEBUG] Itens filtrados (Detalhe):", filteredItemsEmCarteira);
             const itemsAReservar = ALL_PENDING_ITEMS.filter(item => { const poValue = item && item.PO ? String(item.PO) : null; return poValue && reservedPOs.has(poValue); });
             const reservedStockSummary = itemsAReservar.reduce((acc, item) => { const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`; if (!acc[key]) acc[key] = { Pecas_Reservadas: 0, M3_Reservados: 0 }; acc[key].Pecas_Reservadas += item.Pendente_Pecas || 0; acc[key].M3_Reservados += item.Pendente_M3 || 0; return acc; }, {});
             console.log("[DEBUG] Itens reservados:", reservedStockSummary);
             const adjustedStockItems = ALL_STOCK_ITEMS.map(stockItem => {
                 const key = `${stockItem.Produto || 'N/A'}|${stockItem.Perfil || 'N/A'}`;
                 const reserva = reservedStockSummary[key];
                 if (reserva) { return { ...stockItem, M3_Estoque_Liquido: (stockItem.M3_Estoque_Liquido || 0) - reserva.M3_Reservados, Pecas_Estoque_Liquido: (stockItem.Pecas_Estoque_Liquido || 0) - reserva.Pecas_Reservadas }; }
                 return stockItem;
             });
             console.log("[DEBUG] Estoque Ajustado (Dashboard):", adjustedStockItems);
             const dashboardData = calcularDashboard(filteredItemsEmCarteira, adjustedStockItems);
             console.log("[DEBUG] Dados Dashboard:", dashboardData);
             renderDashboard(dashboardData);
             renderDetailTable(filteredItemsEmCarteira);
        }

        // --- Funções de Conclusão (localStorage) ---
        function generateItemId(item) {
             const po = (item.PO || 'na').replace(/[.\#$[\]/]/g, '_');
             const cli = (item.Cliente || 'na').replace(/[.\#$[\]/]/g, '_');
             const perf = (item.Perfil || 'na').replace(/[.\#$[\]/]/g, '_');
             const prod = (item.Produto || 'na').replace(/[.\#$[\]/]/g, '_');
             return `${po}|${cli}|${perf}|${prod}`;
        }
        // v1.5.4: Revertido para localStorage
        function loadCompletionStatus() {
             try { const stored = localStorage.getItem(STORAGE_KEY); completionStatus = stored ? JSON.parse(stored) : {}; console.log("Status carregado (localStorage):", completionStatus); }
             catch (e) { console.error("Erro load status:", e); completionStatus = {}; }
         }
         function saveCompletionStatus() {
             try { localStorage.setItem(STORAGE_KEY, JSON.stringify(completionStatus)); console.log("Status salvo (localStorage):", completionStatus); }
             catch (e) { console.error("Erro save status:", e); }
         }
        window.toggleItemCompletion = function(checkboxElement) {
            const row = checkboxElement.closest('tr'); const itemId = row.getAttribute('data-item-id'); const isChecked = checkboxElement.checked;
            const po = itemId.split('|')[0];
            if (!itemId || po === 'na') { console.error("ID inválido:", itemId); return; }
            completionStatus[itemId] = isChecked; // Atualiza local
            saveCompletionStatus(); // Salva no localStorage
            updatePOVisualStatus(po); // Atualiza visual
            console.log(`Item ${itemId} marcado ${isChecked}`);
        }
        // FIM v1.5.4
        
        window.updatePOVisualStatus = function(po) {
             const tbody = document.getElementById('detail-table').querySelector('tbody');
             const rowsForPO = tbody.querySelectorAll(`tr[data-item-id^="${po}|"]`);
             if (rowsForPO.length === 0) { recalculateAndRenderScroller(); return; }
             let total = 0; let completed = 0;
             rowsForPO.forEach(r => { total++; const id = r.getAttribute('data-item-id'); if (completionStatus[id] === true) completed++; });
             let state = 'pending'; let icon = '';
             if (completed === 0) state = 'pending';
             else if (completed === total) { state = 'full'; icon = '<span class="po-status-icon po-status-completed">✓</span>';}
             else { state = 'partial'; icon = '<span class="po-status-icon po-status-partial">⚠️</span>';}
             rowsForPO.forEach(r => {
                 const poCell = r.cells[1]; const itemId = r.getAttribute('data-item-id'); const isItemDone = completionStatus[itemId] === true;
                 const poText = itemId.split('|')[0];
                 r.classList.remove('completed-row'); const existingIcon = poCell.querySelector('.po-status-icon'); if (existingIcon) existingIcon.remove();
                 poCell.textContent = poText;
                 if (state === 'full') { r.classList.add('completed-row'); poCell.innerHTML += icon; }
                 else if (state === 'partial') { poCell.innerHTML += icon; if (isItemDone) r.classList.add('completed-row'); }
                 else { if (isItemDone) r.classList.add('completed-row'); }
             });
             recalculateAndRenderScroller();
        }
        window.recalculateAndRenderScroller = function() {
            const completedPOsList = [];
            const allItemsByPO = ALL_PENDING_ITEMS.reduce((acc, item) => { const po = item.PO || 'na'; if (po === 'na') return acc; if (!acc[po]) acc[po] = []; acc[po].push(item); return acc; }, {});
            for (const po in allItemsByPO) {
                const items = allItemsByPO[po]; let allDone = true;
                if (items.length === 0) allDone = false;
                else { for (const item of items) { const id = generateItemId(item); if (completionStatus[id] !== true) { allDone = false; break; }}}
                if (allDone) completedPOsList.push(po);
            }
            completedPOsList.sort(); renderCompletedPOScroller(completedPOsList);
        }


        // --- Carregamento Inicial e Recarregamento ---
        function carregarScriptDados() {
            const globalStatus = document.getElementById('global-status'); const dataStatus = document.getElementById('data-status'); const lastUpdated = document.getElementById('data-last-updated');
            globalStatus.textContent = `Carregando ${CAMINHO_JS}...`; globalStatus.className = 'status-box status-loading'; globalStatus.style.opacity = '1'; if (globalStatusTimeout) clearTimeout(globalStatusTimeout);
            dataStatus.textContent = 'Carregando...'; lastUpdated.textContent = '';
            const scriptAntigo = document.getElementById('script-dados'); if (scriptAntigo) scriptAntigo.remove();
            const ts = new Date().getTime(); const src = `${CAMINHO_JS}?v=${ts}`;
            const scriptNovo = document.createElement('script'); scriptNovo.id = 'script-dados'; scriptNovo.src = src;

            scriptNovo.onload = () => {
                lastDataLoadTime = new Date(); dataStatus.textContent = `'${CAMINHO_JS}' carregado.`; lastUpdated.textContent = `Atualizado: ${lastDataLoadTime.toLocaleTimeString('pt-BR')}`; console.log("Dados JS carregados.");
                if (typeof MOCK_ESTOQUE_LIQUIDO !== 'undefined' && typeof MOCK_DADOS_PENDENTES_DETALHADOS !== 'undefined') {
                    ALL_STOCK_ITEMS = MOCK_ESTOQUE_LIQUIDO;
                    ALL_PENDING_ITEMS = MOCK_DADOS_PENDENTES_DETALHADOS.filter(item => (item.Pendente_Pecas || 0) > 0 || (item.Pendente_M3 || 0) > 0.001);
                    uniquePOs = [...new Set(ALL_PENDING_ITEMS.map(item => item.PO))].sort();
                    if (ALL_PENDING_ITEMS.length === 0 && ALL_STOCK_ITEMS.length === 0) { globalStatus.textContent = `AVISO: '${CAMINHO_JS}' vazio.`; globalStatus.className = 'status-box status-loading'; uniquePOs = []; selectedPOs.clear(); reservedPOs.clear(); }
                    else {
                        const itemsEmCarteira = ALL_PENDING_ITEMS;
                        globalStatus.textContent = `SUCESSO: ${itemsEmCarteira.length} itens, ${ALL_STOCK_ITEMS.length} estoque.`; globalStatus.className = 'status-box status-success'; globalStatusTimeout = setTimeout(() => { globalStatus.style.opacity = '0'; }, 3000); console.log("MOCKs ok.");
                        selectedPOs = new Set([...selectedPOs].filter(po => uniquePOs.includes(po)));
                        reservedPOs = new Set([...reservedPOs].filter(po => uniquePOs.includes(po)));
                        if (selectedPOs.size === 0 && uniquePOs.length > 0) selectedPOs = new Set(uniquePOs);
                    }
                    
                    renderPOFilters();
                    const summary = calcularResumoTotal(ALL_PENDING_ITEMS);
                    renderSummary(summary);
                    
                    console.log("[v1.5.4] Dados JS carregados, chamando update...");
                    updateDashboardAndDetail();
                    
                } else { globalStatus.textContent = `ERRO: '${CAMINHO_JS}' ok, mas variáveis MOCK não definidas.`; globalStatus.className = 'status-box status-error'; console.error("MOCKs não encontradas."); /* ... (reset) ... */ }
            };
            scriptNovo.onerror = (e) => { /* ... (tratamento de erro mantido) ... */ };
            document.head.appendChild(scriptNovo);
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            const poSelect = document.getElementById('po-select');
            const poSelectReserva = document.getElementById('po-select-reserva');

            // v1.5.4: Carrega do localStorage primeiro
            loadCompletionStatus();
            // v1.5.4: Carrega dados JS
            carregarScriptDados();

            document.getElementById('reload-button').addEventListener('click', carregarScriptDados);
            document.getElementById('select-all-po').addEventListener('click', selectAllPOs);
            document.getElementById('clear-all-po').addEventListener('click', clearAllPOs);
            document.getElementById('select-all-po-reserva').addEventListener('click', selectAllPOsReserva);
            document.getElementById('clear-all-po-reserva').addEventListener('click', clearAllPOsReserva);

             const handleInteraction = (event) => {
                const selectElement = event.currentTarget;
                const currentScrollTop = selectElement.scrollTop;
                if (event.target.tagName === 'OPTION') event.preventDefault();
                const option = event.target;
                if (option.tagName === 'OPTION') {
                    option.selected = !option.selected;
                    selectElement.dispatchEvent(new Event('change'));
                    requestAnimationFrame(() => { selectElement.scrollTop = currentScrollTop; });
                }
             };

             poSelect.addEventListener('mousedown', handleInteraction);
             poSelect.addEventListener('touchstart', handleInteraction, { passive: false });
             poSelect.addEventListener('change', handleMainPOSelectionChange);

             poSelectReserva.addEventListener('mousedown', handleInteraction);
             poSelectReserva.addEventListener('touchstart', handleInteraction, { passive: false });
             poSelectReserva.addEventListener('change', handleReservationSelectionChange);
        });

        // Disponibilizar funções globais
        window.toggleItemCompletion = toggleItemCompletion;
        window.updatePOVisualStatus = updatePOVisualStatus;
        window.recalculateAndRenderScroller = recalculateAndRenderScroller;


    </script>

</body>
</html>

